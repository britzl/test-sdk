name: "extender:stage channel:alpha"

on:
  push:
    branches:
      - master
  schedule:
    - cron: 0 23 * * *

env:
  VERSION_FILENAME: 'info.json'
  BUILD_SERVER: 'https://build-stage.defold.com'
  CHANNEL: 'alpha'
  PLUGIN_SO: './defold-spine/plugins/lib/x86_64-linux/libSpineExt.so'

jobs:
    switch:
        runs-on: ubuntu-latest
        strategy:
            max-parallel: 2
            matrix:
              projects: [
                  "https://github.com/defold/extension-switch/archive/master.zip",
                ]
        steps:
            - uses: actions/checkout@v2
            - uses: actions/setup-java@v1
              with:
                java-version: '11.0.2'
                architecture: x64

            - name: Get Defold version
            run: |
              TMPVAR=`curl -s http://d.defold.com/${{env.CHANNEL}}/${{env.VERSION_FILENAME}} | jq -r '.sha1'`
              echo "DEFOLD_VERSION=${TMPVAR}" >> $GITHUB_ENV
              echo "Found version ${TMPVAR}"

            - name: Run tests (alpha)
              run: ./run-tests.sh
              env:
                ARCHIVE_PATH: "d-switch.defold.com"
                PLATFORMS: "arm64-nx64"
                PROJECTS: ${{ matrix.projects }}
                USERNAME: ${{ secrets.DM_EXTENDER_USERNAME }}
                PASSWORD: ${{ secrets.DM_EXTENDER_PASSWORD }}
            - name: Notify if tests failed
              uses: homoluctus/slatify@master
              if: failure()
              with:
                type: ${{ job.status }}
                job_name: 'SDK tests (alpha)'
                channel: '#defold-alarms-build'
                url: ${{ secrets.SLACK_WEBHOOK }}

    ps4:
        runs-on: ubuntu-latest
        strategy:
            max-parallel: 2
            matrix:
              projects: [
                  "https://github.com/defold/extension-ps4/archive/master.zip",
                ]
        steps:
            - uses: actions/checkout@v2
            - uses: actions/setup-java@v1
              with:
                java-version: '11.0.2'
                architecture: x64
            - name: Run tests (alpha)
              run: ./run-tests.sh
              env:
                ARCHIVE_PATH: "d-ps4.defold.com"
                PLATFORMS: "x86_64-ps4"
                PROJECTS: ${{ matrix.projects }}
                USERNAME: ${{ secrets.DM_EXTENDER_USERNAME }}
                PASSWORD: ${{ secrets.DM_EXTENDER_PASSWORD }}
            - name: Notify if tests failed
              uses: homoluctus/slatify@master
              if: failure()
              with:
                type: ${{ job.status }}
                job_name: 'SDK tests (alpha)'
                channel: '#defold-alarms-build'
                url: ${{ secrets.SLACK_WEBHOOK }}


    unauth:
        runs-on: ubuntu-latest
        strategy:
            max-parallel: 2
            matrix:
              projects: [
                  "https://github.com/defold/extension-ps4/archive/master.zip",
                ]
        steps:
            - uses: actions/checkout@v2
            - uses: actions/setup-java@v1
              with:
                java-version: '11.0.2'
                architecture: x64
            - name: Run tests (alpha)
              run: ./run-tests.sh
              env:
                ARCHIVE_PATH: "d.defold.com"
                PLATFORMS: "x86_64-ps4"
                PROJECTS: ${{ matrix.projects }}
                USERNAME: "user"
                PASSWORD: "pass"
            - name: Notify if tests failed
              uses: homoluctus/slatify@master
              if: failure()
              with:
                type: ${{ job.status }}
                job_name: 'SDK tests (alpha)'
                channel: '#defold-alarms-build'
                url: ${{ secrets.SLACK_WEBHOOK }}
